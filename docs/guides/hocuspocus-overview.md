# Hocuspocus ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸã‚µãƒ¼ãƒãƒ¼ è§£èª¬ã‚¬ã‚¤ãƒ‰

**Document Version:** 1.0  
**Created:** 2026-02-01  
**Status:** Final  

---

## ç›®æ¬¡

1. [Hocuspocusã¨ã¯ä½•ã‹](#1-hocuspocusã¨ã¯ä½•ã‹)
2. [ãªãœHocuspocusãŒå¿…è¦ãªã®ã‹](#2-ãªãœhocuspocusãŒå¿…è¦ãªã®ã‹)
3. [åŸºç›¤æŠ€è¡“: Y.js ã¨ CRDT](#3-åŸºç›¤æŠ€è¡“-yjs-ã¨-crdt)
4. [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨å‹•ä½œåŸç†](#4-ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨å‹•ä½œåŸç†)
5. [Zediãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã®æ´»ç”¨](#5-zediãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã®æ´»ç”¨)
6. [é¡ä¼¼æŠ€è¡“ã¨ã®æ¯”è¼ƒ](#6-é¡ä¼¼æŠ€è¡“ã¨ã®æ¯”è¼ƒ)
7. [ã‚ˆãã‚ã‚‹è³ªå•](#7-ã‚ˆãã‚ã‚‹è³ªå•)

---

## 1. Hocuspocusã¨ã¯ä½•ã‹

### 1.1 æ¦‚è¦

**Hocuspocus**ã¯ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®WebSocketã‚µãƒ¼ãƒãƒ¼ã§ã™ã€‚[Tiptap](https://tiptap.dev/)ï¼ˆãƒªãƒƒãƒãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ï¼‰ã®é–‹ç™ºãƒãƒ¼ãƒ ã«ã‚ˆã£ã¦ä½œæˆã•ã‚Œã¾ã—ãŸã€‚

```mermaid
flowchart TB
    subgraph Clients["ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ"]
        UA["ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼A<br/>ãƒ–ãƒ©ã‚¦ã‚¶"]
        UB["ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼B<br/>ãƒ–ãƒ©ã‚¦ã‚¶"]
        UC["ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼C<br/>ãƒ–ãƒ©ã‚¦ã‚¶"]
    end
    
    subgraph Server["ã‚µãƒ¼ãƒãƒ¼"]
        HP["ğŸ”„ Hocuspocus Server<br/>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ"]
        DB[("ğŸ’¾ Database<br/>æ°¸ç¶šåŒ–ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸")]
    end
    
    UA -->|WebSocket| HP
    UB -->|WebSocket| HP
    UC -->|WebSocket| HP
    HP --> DB
```

### 1.2 ä¸»ãªç‰¹å¾´

| ç‰¹å¾´ | èª¬æ˜ |
|------|------|
| **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ** | è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç·¨é›†ã‚’å³åº§ã«å…¨å“¡ã«åæ˜  |
| **CRDT ãƒ™ãƒ¼ã‚¹** | Y.js ã‚’ä½¿ç”¨ã—ãŸè¡çªã®ãªã„è‡ªå‹•ãƒãƒ¼ã‚¸ |
| **ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹æ©Ÿèƒ½** | èª°ãŒç·¨é›†ä¸­ã‹ã€ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã®å…±æœ‰ |
| **æ°¸ç¶šåŒ–å¯¾å¿œ** | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®è‡ªå‹•ä¿å­˜ |
| **èªè¨¼çµ±åˆ** | JWTç­‰ã«ã‚ˆã‚‹èªè¨¼ãƒ»èªå¯ |
| **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«** | Redis Pub/Sub ã«ã‚ˆã‚‹è¤‡æ•°ã‚µãƒ¼ãƒãƒ¼æ§‹æˆ |

### 1.3 ã©ã‚“ãªã‚¢ãƒ—ãƒªã§ä½¿ã‚ã‚Œã¦ã„ã‚‹ã‹

- **Notion** ã®ã‚ˆã†ãªãƒãƒ¼ãƒˆã‚¢ãƒ—ãƒª
- **Google Docs** ã®ã‚ˆã†ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç·¨é›†
- **Figma** ã®ã‚ˆã†ãªãƒ‡ã‚¶ã‚¤ãƒ³ãƒ„ãƒ¼ãƒ«
- **Miro** ã®ã‚ˆã†ãªãƒ›ãƒ¯ã‚¤ãƒˆãƒœãƒ¼ãƒ‰
- ã‚³ãƒ¼ãƒ‰å…±åŒç·¨é›†ãƒ„ãƒ¼ãƒ«

---

## 2. ãªãœHocuspocusãŒå¿…è¦ãªã®ã‹

### 2.1 å¾“æ¥ã®æ–¹æ³•ã®å•é¡Œç‚¹

#### âŒ å˜ç´”ãªWebSocketå®Ÿè£…ã®å ´åˆ

```
å•é¡Œ: åŒæ™‚ç·¨é›†æ™‚ã®è¡çª

User A:  "Hello World" â†’ "Hello there World"  (5æ–‡å­—ç›®ã«æŒ¿å…¥)
User B:  "Hello World" â†’ "Hello World!"       (æœ«å°¾ã«è¿½åŠ )
                 â”‚
                 â–¼
         ã©ã¡ã‚‰ãŒæ­£ã—ã„ï¼Ÿ 
         â†’ "Hello there World!" ã«ã—ãŸã„ãŒ...
         â†’ å˜ç´”ãªãƒãƒ¼ã‚¸ã§ã¯ "Hello there World" ã‹ "Hello World!" ã«ãªã‚‹
```

#### âœ… Hocuspocus (CRDT) ã®å ´åˆ

```
User A:  ä½ç½®5ã« "there " ã‚’æŒ¿å…¥
User B:  ä½ç½®11ã« "!" ã‚’æŒ¿å…¥
              â”‚
              â–¼
      CRDTãŒè‡ªå‹•çš„ã«ä¸¡æ–¹ã®å¤‰æ›´ã‚’æ­£ã—ããƒãƒ¼ã‚¸
              â”‚
              â–¼
      çµæœ: "Hello there World!"  â† æ„å›³é€šã‚Šï¼
```

### 2.2 HocuspocusãŒè§£æ±ºã™ã‚‹èª²é¡Œ

| èª²é¡Œ | å¾“æ¥ã®æ–¹æ³• | Hocuspocusã®è§£æ±ºç­– |
|------|-----------|-------------------|
| **ç·¨é›†ã®è¡çª** | å¾Œå‹ã¡ï¼ˆãƒ‡ãƒ¼ã‚¿æå¤±ï¼‰ | CRDTã§è‡ªå‹•ãƒãƒ¼ã‚¸ |
| **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§** | ãƒãƒ¼ãƒªãƒ³ã‚°ï¼ˆé…å»¶ï¼‰ | WebSocketï¼ˆå³æ™‚ï¼‰ |
| **ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œ** | å¯¾å¿œå›°é›£ | IndexedDB + å¾©å¸°æ™‚åŒæœŸ |
| **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£** | å˜ä¸€ã‚µãƒ¼ãƒãƒ¼é™ç•Œ | Redis Pub/Sub |
| **å®Ÿè£…ã‚³ã‚¹ãƒˆ** | éå¸¸ã«é«˜ã„ | è¨­å®šã®ã¿ã§å‹•ä½œ |

---

## 3. åŸºç›¤æŠ€è¡“: Y.js ã¨ CRDT

### 3.1 CRDTã¨ã¯

**CRDT** (Conflict-free Replicated Data Type) ã¯ã€ã€Œè¡çªã—ãªã„ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿å‹ã€ã§ã™ã€‚

```mermaid
flowchart LR
    subgraph Traditional["å¾“æ¥ã®ãƒ‡ãƒ¼ã‚¿åŒæœŸ"]
        direction LR
        A1["ãƒ‡ãƒ¼ã‚¿A"] --> C1{"âš ï¸ è¡çª!"}
        B1["ãƒ‡ãƒ¼ã‚¿B"] --> C1
        C1 --> L1["âŒ ã©ã¡ã‚‰ã‹ã‚’é¸æŠ<br/>ï¼ˆãƒ‡ãƒ¼ã‚¿æå¤±ï¼‰"]
    end
    
    subgraph CRDT["CRDTæ–¹å¼"]
        direction LR
        A2["æ“ä½œA"] --> C2{"âœ… ãƒãƒ¼ã‚¸"}
        B2["æ“ä½œB"] --> C2
        C2 --> L2["ğŸ‰ å…¨å“¡ãŒåŒã˜çµæœ<br/>ï¼ˆãƒ‡ãƒ¼ã‚¿æå¤±ãªã—ï¼‰"]
    end
```

> **ãƒã‚¤ãƒ³ãƒˆ:** ã€Œæœ€çµ‚çš„ãªå€¤ã€ã§ã¯ãªãã€Œæ“ä½œã€ã‚’åŒæœŸã™ã‚‹

### 3.2 Y.js ã®ä»•çµ„ã¿

**Y.js** ã¯ã€CRDTã‚’JavaScriptã§å®Ÿè£…ã—ãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚

```typescript
// Y.js ã®åŸºæœ¬çš„ãªä½¿ã„æ–¹
import * as Y from 'yjs';

// 1. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
const doc = new Y.Doc();

// 2. å…±æœ‰ãƒ‡ãƒ¼ã‚¿å‹ã‚’å–å¾—
const text = doc.getText('content');
const map = doc.getMap('metadata');
const array = doc.getArray('items');

// 3. ãƒ‡ãƒ¼ã‚¿ã‚’æ“ä½œ
text.insert(0, 'Hello');     // ãƒ†ã‚­ã‚¹ãƒˆã‚’æŒ¿å…¥
map.set('title', 'My Doc');  // ã‚­ãƒ¼ãƒ»ãƒãƒªãƒ¥ãƒ¼ã‚’è¨­å®š
array.push(['item1']);       // é…åˆ—ã«è¿½åŠ 

// 4. å¤‰æ›´ã‚’ç›£è¦–
text.observe(event => {
  console.log('ãƒ†ã‚­ã‚¹ãƒˆãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ');
});
```

### 3.3 Y.js ã®ãƒ‡ãƒ¼ã‚¿å‹

| ãƒ‡ãƒ¼ã‚¿å‹ | èª¬æ˜ | ç”¨é€”ä¾‹ |
|----------|------|-------|
| `Y.Text` | ãƒ†ã‚­ã‚¹ãƒˆ | æ–‡ç« ã€ã‚³ãƒ¼ãƒ‰ |
| `Y.Array` | é…åˆ— | ãƒªã‚¹ãƒˆã€ã‚¿ã‚¹ã‚¯ |
| `Y.Map` | ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ | è¨­å®šã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ |
| `Y.XmlFragment` | XML/HTML | ãƒªãƒƒãƒãƒ†ã‚­ã‚¹ãƒˆ |
| `Y.XmlElement` | XMLè¦ç´  | æ§‹é€ åŒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ |

### 3.4 ãªãœã€Œè¡çªã—ãªã„ã€ã®ã‹

```mermaid
flowchart TB
    subgraph Operations["å„æ“ä½œã«ã¯ä¸€æ„ã®IDãŒä»˜ä¸ã•ã‚Œã‚‹"]
        OpA["User A ã®æ“ä½œ<br/>id: A:1, type: insert, pos: 5"]
        OpB["User B ã®æ“ä½œ<br/>id: B:1, type: insert, pos: 11"]
    end
    
    subgraph Rules["æ“ä½œã®é †åºæ±ºå®šãƒ«ãƒ¼ãƒ«"]
        R1["1ï¸âƒ£ å› æœé–¢ä¿‚ãŒã‚ã‚‹æ“ä½œ<br/>â†’ ãã®é †åºã‚’ä¿æŒ"]
        R2["2ï¸âƒ£ ä¸¦è¡Œãªæ“ä½œ<br/>â†’ IDã®è¾æ›¸é †ã§ä¸€æ„ã«æ±ºå®š"]
    end
    
    subgraph Result["çµæœ"]
        Res["âœ… ã©ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã‚‚<br/>åŒã˜é †åºã§æ“ä½œãŒé©ç”¨ã•ã‚Œã‚‹<br/>â†’ æœ€çµ‚çŠ¶æ…‹ãŒå¿…ãšä¸€è‡´"]
    end
    
    Operations --> Rules
    Rules --> Result
```

---

## 4. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨å‹•ä½œåŸç†

### 4.1 å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```mermaid
flowchart TB
    subgraph Client["ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´"]
        subgraph Editor["Tiptap Editor"]
            TE["ğŸ“ ãƒªãƒƒãƒãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ‡ã‚£ã‚¿"]
            CE["Collaboration Extension"]
            CCE["CollaborationCaret Extension"]
        end
        
        subgraph YDoc["Y.Doc (Single Source of Truth)"]
            XF["Y.XmlFragment<br/>æœ¬æ–‡"]
            YM["Y.Map<br/>ãƒ¡ã‚¿æƒ…å ±"]
            AW["Awareness<br/>ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹"]
        end
        
        subgraph Providers["ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼"]
            IDB["y-indexeddb<br/>ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜"]
            WS["y-websocket<br/>WebSocket"]
            AWP["Awareness Provider<br/>ã‚«ãƒ¼ã‚½ãƒ«å…±æœ‰"]
        end
        
        Editor --> YDoc
        YDoc --> Providers
    end
    
    subgraph Server["ã‚µãƒ¼ãƒãƒ¼å´"]
        subgraph HP["Hocuspocus Server"]
            Core["Core Engine<br/>â€¢ WebSocketæ¥ç¶šç®¡ç†<br/>â€¢ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆçŠ¶æ…‹ç®¡ç†<br/>â€¢ Y.jsæ›´æ–°ã®é…ä¿¡<br/>â€¢ Awarenessã®åŒæœŸ"]
            
            subgraph Hooks["ãƒ•ãƒƒã‚¯"]
                H1["onConnect"]
                H2["onStore"]
                H3["onAuthenticate"]
            end
        end
        
        subgraph Extensions["Extensions"]
            RE["Redis Extension<br/>è¤‡æ•°ã‚µãƒ¼ãƒãƒ¼é–“åŒæœŸ"]
            DE["Database Extension<br/>æ°¸ç¶šåŒ–"]
            WE["Webhook Extension<br/>å¤–éƒ¨é€£æº"]
        end
        
        subgraph Storage["ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸"]
            Redis[("ElastiCache Redis")]
            Aurora[("Aurora PostgreSQL")]
        end
        
        HP --> Extensions
        RE --> Redis
        DE --> Aurora
    end
    
    WS <-->|WebSocket| HP
    AWP <-->|WebSocket| HP
```

### 4.2 ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

#### 4.2.1 ç·¨é›†ã®åŒæœŸãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    participant A as User A
    participant H as Hocuspocus
    participant B as User B
    participant DB as Database
    
    A->>H: 1. Hello ã‚’å…¥åŠ› Y.js update
    
    Note over H: 2. æ›´æ–°ã‚’é©ç”¨
    
    H->>B: Y.js update é…ä¿¡
    
    Note over B: 3. Y.Docã‚’æ›´æ–° è‡ªå‹•ãƒãƒ¼ã‚¸
    
    H-->>DB: 4. DBã«ä¿å­˜ éåŒæœŸ
```

#### 4.2.2 æ¥ç¶šã€œç·¨é›†é–‹å§‹ã¾ã§ã®ãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    participant C as Client
    participant H as Hocuspocus
    participant DB as Database
    
    C->>H: 1. WebSocketæ¥ç¶šè¦æ±‚ + JWTãƒˆãƒ¼ã‚¯ãƒ³
    
    Note over H: 2. onAuthenticate ãƒ•ãƒƒã‚¯ JWTã‚’æ¤œè¨¼
    
    Note over H: 3. onLoadDocument ãƒ•ãƒƒã‚¯
    H->>DB: æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
    DB-->>H: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿
    
    H->>C: 4. åˆæœŸåŒæœŸ Y.Docå…¨ä½“ã‚’é€ä¿¡
    
    Note over C,H: 5. ç·¨é›†é–‹å§‹å¯èƒ½ åŒæ–¹å‘åŒæœŸ
```

### 4.3 Hocuspocusã®ãƒ•ãƒƒã‚¯ï¼ˆæ‹¡å¼µãƒã‚¤ãƒ³ãƒˆï¼‰

```typescript
import { Hocuspocus } from '@hocuspocus/server';

const server = new Hocuspocus({
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // èªè¨¼ãƒ•ãƒƒã‚¯: æ¥ç¶šæ™‚ã«å‘¼ã°ã‚Œã‚‹
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async onAuthenticate({ token, documentName }) {
    // JWTã‚’æ¤œè¨¼
    const user = verifyJWT(token);
    
    // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’ãƒã‚§ãƒƒã‚¯
    const hasAccess = await checkPermission(user, documentName);
    
    if (!hasAccess) {
      throw new Error('ã‚¢ã‚¯ã‚»ã‚¹æ¨©ãŒã‚ã‚Šã¾ã›ã‚“');
    }
    
    // è¿”ã—ãŸå€¤ã¯ context ã¨ã—ã¦å¾Œç¶šã®ãƒ•ãƒƒã‚¯ã§ä½¿ãˆã‚‹
    return { user };
  },

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆèª­ã¿è¾¼ã¿ãƒ•ãƒƒã‚¯
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async onLoadDocument({ documentName }) {
    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰æ—¢å­˜ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰
    const existingData = await database.getDocument(documentName);
    
    if (existingData) {
      // Y.jså½¢å¼ã§è¿”ã™
      return existingData;
    }
    
    // æ–°è¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å ´åˆã¯ null ã‚’è¿”ã™
    return null;
  },

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ä¿å­˜ãƒ•ãƒƒã‚¯: å®šæœŸçš„ or å¤‰æ›´æ™‚ã«å‘¼ã°ã‚Œã‚‹
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async onStoreDocument({ documentName, document }) {
    // Y.Docã‚’ãƒã‚¤ãƒŠãƒªã«å¤‰æ›
    const state = Y.encodeStateAsUpdate(document);
    
    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
    await database.saveDocument(documentName, state);
  },

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // æ¥ç¶šãƒ•ãƒƒã‚¯
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async onConnect({ documentName, context }) {
    console.log(`${context.user.name} ãŒæ¥ç¶šã—ã¾ã—ãŸ`);
  },

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // åˆ‡æ–­ãƒ•ãƒƒã‚¯
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async onDisconnect({ documentName, context }) {
    console.log(`${context.user.name} ãŒåˆ‡æ–­ã—ã¾ã—ãŸ`);
  },
});
```

---

## 5. Zediãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã®æ´»ç”¨

### 5.1 Zediã«ãŠã‘ã‚‹å½¹å‰²

Zediã¯ã€Notioné¢¨ã®ãƒãƒ¼ãƒˆã‚¢ãƒ—ãƒªã§ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæ™‚ç·¨é›†æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

```mermaid
flowchart TB
    User["ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼"]
    
    subgraph Frontend["Zedi Frontend (React + Tiptap)"]
        PL["ğŸ“‹ ãƒšãƒ¼ã‚¸ä¸€è¦§"]
        ED["ğŸ“ ã‚¨ãƒ‡ã‚£ã‚¿<br/>Tiptap + Y.js"]
        SB["ğŸ“ ã‚µã‚¤ãƒ‰ãƒãƒ¼"]
    end
    
    subgraph DataLayer["ãƒ‡ãƒ¼ã‚¿å±¤"]
        REST["ğŸŒ REST API<br/>(Lambda)<br/>ãƒ»ãƒšãƒ¼ã‚¸ä¸€è¦§<br/>ãƒ»æ¤œç´¢<br/>ãƒ»ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿"]
        WS["ğŸ”„ Hocuspocus<br/>WebSocket<br/>ãƒ»ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ<br/>ãƒ»ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹"]
        IDB["ğŸ’¾ IndexedDB<br/>(ãƒ­ãƒ¼ã‚«ãƒ«)<br/>ãƒ»ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç·¨é›†"]
    end
    
    subgraph AWS["AWS Cloud"]
        Aurora[("Aurora<br/>PostgreSQL")]
        Redis[("ElastiCache<br/>Redis")]
        ECS["ECS<br/>Fargate"]
    end
    
    User --> Frontend
    ED --> REST
    ED --> WS
    ED --> IDB
    REST --> Aurora
    WS --> ECS
    ECS --> Redis
    ECS --> Aurora
```

### 5.2 ç¾åœ¨ã®ã‚¤ãƒ³ãƒ•ãƒ©æ§‹æˆï¼ˆPhase 5 å®Œäº†æ™‚ç‚¹ï¼‰

| ãƒªã‚½ãƒ¼ã‚¹ | ã‚µãƒ¼ãƒ“ã‚¹ | ç”¨é€” |
|----------|---------|------|
| **ECS Fargate Spot** | Hocuspocusã‚µãƒ¼ãƒãƒ¼ | WebSocketå‡¦ç† |
| **ALB** | ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ | WebSocketçµ‚ç«¯ |
| **ECR** | ã‚³ãƒ³ãƒ†ãƒŠãƒ¬ã‚¸ã‚¹ãƒˆãƒª | Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ä¿å­˜ |
| **ElastiCache Redis** | Pub/Sub | è¤‡æ•°ã‚µãƒ¼ãƒãƒ¼é–“åŒæœŸ |
| **Aurora PostgreSQL** | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ | ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ°¸ç¶šåŒ– |
| **Cognito** | èªè¨¼ | JWTç™ºè¡Œãƒ»æ¤œè¨¼ |

### 5.3 æ¥ç¶šæƒ…å ±

```
WebSocket URL:  ws://zedi-dev-alb-1515915657.ap-northeast-1.elb.amazonaws.com
ECR Repository: 590183877893.dkr.ecr.ap-northeast-1.amazonaws.com/zedi-dev-hocuspocus
ECS Cluster:    zedi-dev-cluster
ECS Service:    zedi-dev-hocuspocus
```

è©³ç´°ã¯ [hocuspocus-server-implementation.md](../work-logs/20260131/hocuspocus-server-implementation.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

---

## 6. é¡ä¼¼æŠ€è¡“ã¨ã®æ¯”è¼ƒ

### 6.1 ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸæŠ€è¡“ã®æ¯”è¼ƒ

| æŠ€è¡“ | æ–¹å¼ | é•·æ‰€ | çŸ­æ‰€ |
|------|------|------|------|
| **Hocuspocus + Y.js** | CRDT | è¡çªãªã—ã€ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œ | å­¦ç¿’ã‚³ã‚¹ãƒˆ |
| **Firebase Realtime DB** | Last-write-wins | ç°¡å˜ã«ä½¿ãˆã‚‹ | è¡çªã§ä¸Šæ›¸ã |
| **Socket.io** | æ‰‹å‹•åŒæœŸ | æŸ”è»Ÿæ€§ãŒé«˜ã„ | è‡ªå‰å®Ÿè£…ãŒå¤§å¤‰ |
| **Operational Transform** | OT | Google Docsã§å®Ÿç¸¾ | ã‚µãƒ¼ãƒãƒ¼ä¸­å¤®é›†æ¨© |
| **ShareDB** | OT | JSONã«æœ€é©åŒ– | CRDTã‚ˆã‚Šè¤‡é›‘ |

### 6.2 Y.js vs Operational Transform (OT)

| è¦³ç‚¹ | Y.js (CRDT) | Operational Transform (OT) |
|------|-------------|---------------------------|
| **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£** | åˆ†æ•£å‹ï¼ˆP2Pã‚‚å¯èƒ½ï¼‰ | ä¸­å¤®é›†æ¨©å‹ï¼ˆã‚µãƒ¼ãƒãƒ¼ãŒæ­£ï¼‰ |
| **ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œ** | âœ… ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Œçµ | âš ï¸ ã‚µãƒ¼ãƒãƒ¼ã¨ã®æ•´åˆæ€§ãŒé›£ã—ã„ |
| **å®Ÿè£…é›£æ˜“åº¦** | ã‚·ãƒ³ãƒ—ãƒ«ï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªä»»ã›ï¼‰ | è¤‡é›‘ï¼ˆæ“ä½œã”ã¨ã«å¤‰æ›ãŒå¿…è¦ï¼‰ |
| **ãƒ¡ãƒ¢ãƒªåŠ¹ç‡** | ã‚„ã‚„å¤šã‚ï¼ˆå±¥æ­´ã‚‚ä¿æŒï¼‰ | åŠ¹ç‡çš„ï¼ˆç¾åœ¨çŠ¶æ…‹ã®ã¿ï¼‰ |
| **åæŸä¿è¨¼** | âœ… æ•°å­¦çš„ã«è¨¼æ˜ | å®Ÿè£…æ¬¡ç¬¬ï¼ˆãƒ‘ã‚ºãƒ«ãŒè¤‡é›‘ï¼‰ |

> **çµè«–:** æ–°è¦é–‹ç™ºãªã‚‰ **Y.js (CRDT) ãŒãŠã™ã™ã‚**

### 6.3 Hocuspocus vs ä»–ã®Y.jsã‚µãƒ¼ãƒãƒ¼

| ã‚µãƒ¼ãƒãƒ¼ | ç‰¹å¾´ | ãŠã™ã™ã‚ç”¨é€” |
|----------|------|------------|
| **Hocuspocus** | é«˜æ©Ÿèƒ½ã€Tiptapçµ±åˆ | ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ |
| **y-websocket** | æœ€å°é™ã®å®Ÿè£… | ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ— |
| **Liveblocks** | SaaSå‹ | æ™‚é–“ç¯€ç´„ã—ãŸã„å ´åˆ |
| **Partykit** | ã‚¨ãƒƒã‚¸å®Ÿè¡Œ | ä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·é‡è¦– |

---

## 7. ã‚ˆãã‚ã‚‹è³ªå•

### Q1: ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã«ç·¨é›†ã—ãŸã‚‰ã©ã†ãªã‚Šã¾ã™ã‹ï¼Ÿ

IndexedDBã«ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¾©å¸°æ™‚ã«è‡ªå‹•çš„ã«ã‚µãƒ¼ãƒãƒ¼ã¨åŒæœŸã•ã‚Œã€CRDTã«ã‚ˆã‚Šè¡çªãªããƒãƒ¼ã‚¸ã•ã‚Œã¾ã™ã€‚

```mermaid
flowchart LR
    subgraph Offline["ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä¸­"]
        E1["ğŸ“ Editor"] --> IDB1[("IndexedDB")]
    end
    
    subgraph Online["ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¾©å¸°æ™‚"]
        IDB2[("IndexedDB")] --> HP["ğŸ”„ Hocuspocus"] --> SYNC["âœ… åŒæœŸå®Œäº†"]
    end
```

### Q2: 100äººãŒåŒæ™‚ã«ç·¨é›†ã—ãŸã‚‰ã©ã†ãªã‚Šã¾ã™ã‹ï¼Ÿ

Hocuspocusã¯è¨­è¨ˆä¸Šã€å¤šæ•°ã®åŒæ™‚æ¥ç¶šã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚

1. Redis Pub/Sub ã«ã‚ˆã‚Šè¤‡æ•°ã‚µãƒ¼ãƒãƒ¼ã«ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ
2. å·®åˆ†ã®ã¿ã‚’é€ä¿¡ã™ã‚‹ãŸã‚å¸¯åŸŸåŠ¹ç‡ãŒè‰¯ã„
3. Awareness (ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹) ã¯è»½é‡ãªãƒ‡ãƒ¼ã‚¿

> **å®Ÿç¸¾:** Notionç­‰ã§æ•°åäººã®åŒæ™‚ç·¨é›†ã¯ä¸€èˆ¬çš„

### Q3: ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ã¯ä¿è¨¼ã•ã‚Œã¾ã™ã‹ï¼Ÿ

ã¯ã„ã€‚CRDTã®æ•°å­¦çš„æ€§è³ªã«ã‚ˆã‚Šä¿è¨¼ã•ã‚Œã¾ã™ã€‚

- âœ… ã©ã®é †åºã§æ“ä½œãŒé©ç”¨ã•ã‚Œã¦ã‚‚æœ€çµ‚çŠ¶æ…‹ã¯åŒä¸€
- âœ… ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é…å»¶ãŒã‚ã£ã¦ã‚‚å•é¡Œãªã—
- âœ… æ“ä½œãŒå¤±ã‚ã‚Œãªã„é™ã‚Šãƒ‡ãƒ¼ã‚¿ã¯æå¤±ã—ãªã„

### Q4: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¯ã©ã†ãªã£ã¦ã„ã¾ã™ã‹ï¼Ÿ

è¤‡æ•°ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ä¿è­·ã—ã¦ã„ã¾ã™ã€‚

| ãƒ¬ã‚¤ãƒ¤ãƒ¼ | æŠ€è¡“ |
|----------|------|
| èªè¨¼ | Cognito JWT |
| èªå¯ | onAuthenticate ãƒ•ãƒƒã‚¯ |
| é€šä¿¡æš—å·åŒ– | WSS (WebSocket Secure) |
| ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ | VPCå†…ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆ |

### Q5: ã©ã®ãã‚‰ã„ã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿ

ä¸€èˆ¬çš„ã« **100-200ms** ç¨‹åº¦ã§ã™ã€‚

```mermaid
flowchart LR
    A["ğŸ‘¤ Client"] -->|~30-50ms| B["ALB"]
    B -->|~5ms| C["ECS"]
    C -->|~1ms| D["Redis"]
    C -->|~30-50ms| E["ğŸ‘¤ Other Client"]
```

---

## å‚è€ƒãƒªãƒ³ã‚¯

- [Hocuspocus å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://hocuspocus.dev/)
- [Y.js å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.yjs.dev/)
- [Tiptap å…¬å¼ã‚µã‚¤ãƒˆ](https://tiptap.dev/)
- [CRDT Wikipedia](https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type)
- [Zedi ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæ™‚ç·¨é›†ä»•æ§˜](../specs/realtime-collaboration-specification.md)
- [Hocuspocusã‚µãƒ¼ãƒãƒ¼å®Ÿè£…ã‚¬ã‚¤ãƒ‰](../work-logs/20260131/hocuspocus-server-implementation.md)

---

*ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯2026-02-01ã«ä½œæˆã•ã‚Œã¾ã—ãŸã€‚*
