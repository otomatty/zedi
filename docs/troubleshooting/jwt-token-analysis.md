# JWTトークン分析レポート

## リクエスト情報

- **URL**: `https://zedi-otomatty.aws-ap-northeast-1.turso.io/v2/pipeline`
- **ステータス**: 401 Unauthorized
- **Origin**: `https://zedi-note.app`
- **Authorizationヘッダー**: 含まれている ✓

## JWTトークンペイロード分析

### デコードされたペイロード

```json
{
  "a": "rw",                    // アクセス権限: read-write ✓
  "azp": "https://zedi-note.app", // 承認されたパーティ
  "exp": 1767409368,            // 有効期限: 2026-01-03T03:02:48Z
  "iat": 1767409308,            // 発行時刻: 2026-01-03T03:01:48Z
  "id": "33057661-834e-4891-9b48-802d425d02b9", // データベースID ✓
  "iss": "https://clerk.zedi-note.app", // 発行者 ✓
  "jti": "e3410c9f8c9320fbec8f", // JWT ID
  "nbf": 1767409303,            // 有効開始時刻
  "perm": [],                   // 詳細な権限（空 = 全テーブル） ✓
  "rid": "b2043790-8e2f-46f1-993e-13f45705af34", // リソースID ✓
  "sub": "user_37jAIdMFr4gzT466LyJEhpchQMa" // ユーザーID
}
```

### 検証結果

✅ **必要なクレームがすべて含まれている**:
- `a`: "rw" (read-write)
- `id`: "33057661-834e-4891-9b48-802d425d02b9" (データベースID)
- `perm`: [] (全テーブルにアクセス)
- `rid`: "b2043790-8e2f-46f1-993e-13f45705af34" (リソースID)

✅ **有効期限**: まだ有効（2026-01-03T03:02:48Zまで）

✅ **発行者**: `https://clerk.zedi-note.app` (正しい)

## 問題の原因

JWTトークンは正しく生成されていますが、401エラーが発生しているということは、**Turso側でJWKSエンドポイントがデータベースに関連付けられていない**可能性が高いです。

### 考えられる原因

1. **データベースにJWKSが関連付けられていない**
   - 組織レベルでJWKSが登録されていても、データベースレベルで有効化されていない可能性

2. **JWKSエンドポイントの検証に失敗している**
   - TursoがJWKSエンドポイントから公開鍵を取得できない
   - 公開鍵の検証に失敗している

3. **リソースID (`rid`) の不一致**
   - データベースのリソースIDとJWTトークンの`rid`が一致していない可能性

## 確認すべき点

### 1. JWKSエンドポイントのアクセシビリティ

```bash
curl https://clerk.zedi-note.app/.well-known/jwks.json
```

このコマンドでJWKSエンドポイントが正しくアクセス可能か確認してください。

### 2. データベースのリソースID確認

```bash
turso db show zedi
```

データベースのリソースIDが `b2043790-8e2f-46f1-993e-13f45705af34` と一致しているか確認してください。

### 3. Turso側のJWKS設定確認

TursoダッシュボードまたはCLIで、データベース `zedi` にJWKSエンドポイント `Zedi Clerk` が関連付けられているか確認してください。

## 推奨される対処法

1. **Tursoサポートに問い合わせ**
   - データベースにJWKSを関連付ける方法を確認
   - [Turso Discord](https://discord.gg/turso) または [Turso Support](https://turso.tech/support)
   - エラーメッセージ、データベース名、JWKSエンドポイントを含めて報告

2. **Turso CLIの最新バージョンを確認**
   - 現在のバージョン: v1.0.15
   - 最新バージョンにアップデートして、新しいコマンドが追加されていないか確認

3. **Tursoダッシュボードで確認**
   - データベース `zedi` の設定ページでJWKS関連の設定があるか確認
   - データベースレベルでJWKSを有効化するオプションがあるか確認
