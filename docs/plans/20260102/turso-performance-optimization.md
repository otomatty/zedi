# 実装計画書: TursoDB パフォーマンス最適化

## 概要

| 項目       | 内容                                                                   |
| :--------- | :--------------------------------------------------------------------- |
| **機能名** | TursoDB Performance Optimization（パフォーマンス最適化）               |
| **目的**   | Rows Read の削減によるコスト削減とレスポンス改善                       |
| **優先度** | 🔴 緊急（コスト・スケーラビリティに直結）                              |
| **依存**   | 既存のページ管理機能（✅ 実装済み）                                    |
| **状態**   | ✅ Phase 1 + Phase 1.5 実装完了                                        |

---

## 実装状況サマリー

| Phase | 内容 | 状態 | Rows Read |
| :---- | :--- | :--- | :-------- |
| Phase 1 | クエリ最適化（PageSummary等） | ✅ 完了 | 90%削減 |
| Phase 1.5 | ローカルファースト（WASM DB） | ✅ 完了 | **0** |
| Phase 2 | Turso Embedded Replicas | ⏸️ 不要（Phase 1.5で達成） | - |
| Phase 3 | Tauri移行でのネイティブSQLite | 📋 将来計画 | - |

---

## 現状分析

### 問題点（改善前）

現在の実装では、以下の箇所で **全ページの全データ（content 含む）** を取得しており、Rows Read が大量に発生していました：

| 呼び出し箇所 | 関数 | 問題点 |
| :----------- | :--- | :----- |
| ページリスト表示 | `getPages()` | 全ページの content（10KB/ページ）を取得 |
| グローバル検索 | `useGlobalSearch` → `usePages` | 検索のために全ページを取得してクライアントでフィルタリング |
| WikiLink存在確認 | `useWikiLinkExistsChecker` | 全ページを取得してタイトルマップを構築 |
| リンク同期 | `useSyncWikiLinks` | 全ページを取得 |
| リンクページ計算 | `useLinkedPages` | 全ページを取得して2-hopリンク計算 |

### 影響規模（改善前）

| ページ数 | content サイズ | 1回の取得データ量 | 月間 Rows Read（10回/日） |
| :------- | :------------- | :---------------- | :------------------------ |
| 50       | 10KB           | 500KB             | 15,000 rows               |
| 500      | 10KB           | 5MB               | 150,000 rows              |
| 1,000    | 10KB           | 10MB              | 300,000 rows              |

---

## Phase 1: クエリ最適化（✅ 実装完了）

### 実装内容

| 変更 | ファイル | 説明 |
| :--- | :------- | :--- |
| `PageSummary` 型追加 | `src/types/page.ts` | content を除外した軽量型 |
| `getPagesSummary()` 追加 | `src/lib/pageRepository.ts` | サマリーのみ取得するメソッド |
| `getPagesByIds()` 追加 | `src/lib/pageRepository.ts` | 特定IDのページのみ取得 |
| `usePagesSummary()` 追加 | `src/hooks/usePageQueries.ts` | サマリー取得フック |
| 検索最適化 | `src/hooks/useGlobalSearch.ts` | サーバーサイド検索 |
| WikiLink最適化 | `src/hooks/usePageQueries.ts` | サマリーを使用 |
| リンク計算最適化 | `src/hooks/useLinkedPages.ts` | サマリー + 選択的フェッチ |

### 効果

| 操作 | 改善前 | Phase 1 後 | 削減率 |
| :--- | :----- | :--------- | :----- |
| ページリスト表示 | 全カラム（10KB×N） | サマリー（0.5KB×N） | **95%** |
| グローバル検索 | 全ページ取得 | サーバーサイド検索 | **90%** |
| WikiLink確認 | 全ページ取得 | サマリー取得 | **95%** |
| リンクページ計算 | 全ページ取得 | サマリー + 必要ページのみ | **80%** |

---

## Phase 1.5: ローカルファースト（✅ 実装完了）

### 概要

完全なローカルファーストアーキテクチャを実装。**すべての読み書きがローカルWASMデータベースで行われ、通常操作での Rows Read = 0** を達成。

### アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           ブラウザ                                          │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                 ローカル WASM データベース                             │ │
│  │                （@libsql/client-wasm + IndexedDB永続化）               │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │ │
│  │  │  すべての読み取り: ローカルから即座に応答（Rows Read = 0）       │  │ │
│  │  │  すべての書き込み: ローカルに即座に保存（Rows Read = 0）         │  │ │
│  │  └─────────────────────────────────────────────────────────────────┘  │ │
│  │                                                                        │ │
│  │  永続化: IndexedDB（ブラウザリロード後も維持）                         │ │
│  │  バックグラウンド同期: 認証ユーザーのみ、60秒間隔（stale時のみ）       │ │
│  └────────────────────────┬───────────────────────────────────────────────┘ │
│                           │ バックグラウンド同期（認証ユーザー + stale時）  │
│                           ↓                                                 │
└───────────────────────────┼─────────────────────────────────────────────────┘
                            │
                            ↓
┌───────────────────────────────────────────────────────────────────────────────┐
│                         リモート Turso DB                                     │
│                       （マルチデバイス同期用）                                │
└───────────────────────────────────────────────────────────────────────────────┘
```

### 実装内容

| ファイル | 変更内容 |
| :------- | :------- |
| `src/lib/turso.ts` | `getLocalClient()` (WASM), `syncWithRemote()`, `isSyncStale()`, 同期状態管理 |
| `src/hooks/usePageQueries.ts` | `useRepository()` をローカルファースト対応、stale チェック追加 |
| `src/components/layout/SyncIndicator.tsx` | 同期状態表示コンポーネント |
| `src/components/layout/Header.tsx` | SyncIndicator をヘッダーに追加 |
| `vite.config.ts` | `vite-plugin-wasm`, `vite-plugin-top-level-await` 追加 |

### 使用パッケージ

```json
{
  "@libsql/client-wasm": "^0.15.15",
  "vite-plugin-wasm": "^3.5.0",
  "vite-plugin-top-level-await": "^1.6.0"
}
```

### 動作フロー

1. **すべての読み書き**:
   - ローカルWASMデータベースで即座に処理
   - IndexedDBに自動永続化
   - **Rows Read = 0**

2. **差分同期（Delta Sync）**:
   - **トリガー**: ページ読み込み時（セッション初回のみ）+ 手動同期ボタン
   - **バックグラウンド自動同期なし** - ユーザーが明示的に同期
   - **差分のみ取得**: `updated_at > lastSyncTime` のデータのみリクエスト
   - コンフリクト解決：`updated_at` が新しい方を優先

3. **オフライン対応**:
   - オフラインでも読み書き可能
   - オンラインになったら手動で同期

### 効果

| 操作 | Phase 1 | Phase 1.5 (ローカルファースト) |
| :--- | :------ | :----------------------------- |
| ページリスト表示 | サマリーのみ取得 | **ローカルから取得（Rows Read = 0）** |
| ページ詳細表示 | リモートから取得 | **ローカルから取得（Rows Read = 0）** |
| 検索 | サーバーサイド検索 | **ローカルで検索（Rows Read = 0）** |
| ページ作成 | リモートに書き込み | **ローカルに書き込み（Rows Read = 0）** |
| ページ更新 | リモートに書き込み | **ローカルに書き込み（Rows Read = 0）** |
| 差分同期 | - | **lastSyncTime以降の変更のみ（Rows Read 最小）** |

### 同期状態UI

ヘッダーに同期インジケーターを表示：

| 状態 | アイコン | 説明 |
| :--- | :------- | :--- |
| idle | ☁️ | クラウド同期可能 |
| syncing | 🔄 | 同期中 |
| synced | ✅ | 同期完了 |
| error | ⚠️ | 同期エラー（クリックで再試行） |
| offline | 📴 | オフラインモード |

### 同期方式

```
【初回同期】（lastSyncTime = null）
リモートから全データ取得 → ローカルに保存

【差分同期】（lastSyncTime あり）
リモート: WHERE updated_at > lastSyncTime
ローカル: WHERE updated_at > lastSyncTime
→ 変更されたデータのみ同期（Rows Read 最小化）
```

### 制約・注意点

1. **初回同期**: 認証ユーザーは初回ログイン時にリモートから同期（Rows Read 発生）
2. **マルチデバイス**: バックグラウンド同期で60秒以内に反映
3. **メモリ使用量**: WASMデータベースがメモリを使用（ページ数に比例）
4. **コンフリクト**: `updated_at` が新しい方を優先する自動解決

---

## Phase 2: Turso Embedded Replicas（⏸️ 不要）

Phase 1.5 のローカルファースト実装で Rows Read = 0 を達成したため、Embedded Replicas の追加実装は不要になりました。

将来的にTursoが提供するEmbedded Replicasのブラウザサポートが改善された場合、現在の実装をシンプルに置き換えることができます。

---

## Phase 3: Tauri移行（📋 将来計画）

### 概要

Tauri アプリに移行後、ネイティブSQLiteを使用してさらに高速化。

### メリット

| 項目 | 現在（WASM） | Tauri移行後 |
| :--- | :----------- | :---------- |
| データベース | WASM SQLite | ネイティブ SQLite |
| パフォーマンス | 良好 | **最高** |
| メモリ使用量 | 中程度 | **最小** |
| ストレージ | IndexedDB | ファイルシステム |

### 詳細

`tauri-migration.md` を参照。

---

## 成功指標

| 指標 | 改善前 | Phase 1 | Phase 1.5 | 目標達成 |
| :--- | :----- | :------ | :-------- | :------- |
| ページリスト表示の Rows Read | N | N × 0.05 | **0** | ✅ |
| 検索の Rows Read | N | 検索結果数のみ | **0** | ✅ |
| 月間 Rows Read（1000ページ想定） | 300,000 | 30,000 | **~0**（同期時のみ） | ✅ |
| ページリスト表示のレスポンス | 500ms+ | 200ms | **<50ms** | ✅ |

---

## 関連ドキュメント

- [PRD: データ永続化](../PRD.md)
- [Tauri Migration Plan](../20260101/tauri-migration.md)
- [Turso Embedded Replicas Documentation](https://docs.turso.tech/features/embedded-replicas)
