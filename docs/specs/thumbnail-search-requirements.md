# サムネイル検索・挿入 要件定義

作成日: 2026-01-18  
対象: ページ編集画面のサムネイル設定体験  
目的: サムネイル未設定のページに対して、Web検索した画像候補を提示し、選択した画像をGyazoへ保存してページ先頭に挿入する。

---

## 1. 背景・前提
- 本アプリにおけるサムネイルは「ページ先頭の画像」。
- サムネイル未設定（先頭画像なし）の場合のみ、候補表示を提供する。
- 画像の保存先はGyazoを想定（Gyazoが未設定の場合は設定誘導）。

---

## 2. ユーザーストーリー
- ユーザーはページ下部の「サムネイルを設定」から、タイトルに関連する画像候補を確認したい。
- 候補から選んだ画像を、ページ先頭に挿入し即保存したい。
- Wikipedia（Wikimedia Commons）だけでなく、他のWeb画像も検索対象に含めたい。
- よい候補がない場合、次の候補（次の10件）をすぐに表示したい。

---

## 3. 機能要件

### 3.1 表示条件
- サムネイル未設定（ページ先頭の画像が存在しない）時のみ表示。
- 読み取り専用（生成中など）では表示しない。

### 3.2 検索開始トリガー
- 「サムネイルを設定」ボタンをクリックした時のみ検索を開始する。
- 検索キーワードはページタイトルのみ。

### 3.3 候補表示
- 1回の検索で10件表示。
- 横スクロール対応（スワイプ + スナップ）。
- マウスホイール縦スクロールで横スクロールに変換。
- モバイルはカードサイズを小さくする。
- 画像のアトリビューション（提供元リンク・作者リンク）を表示する。

### 3.4 ページング（次へ）
- 「次へ」ボタンを表示し、次の10件を取得して表示する。
- 取得中はローディング表示。
- 次へは連続で使用可能（ページ番号やオフセットで取得する）。

### 3.5 画像選択時の挙動
- 選択した画像をGyazoへ保存してURLを取得。
- 取得したURLをページ先頭に挿入する。
- 既存の先頭画像があっても、先頭に追加し旧画像は2番目になる。
- 画像挿入後は即保存を実行する。

### 3.6 ストレージ設定
- Gyazo未設定時はストレージ設定ダイアログに誘導する。
- Gyazo以外のストレージ設定時は、Gyazoへ切り替える案内を表示する。

---

## 4. 非機能要件
- 検索結果の取得は3秒以内を目標（失敗時は再試行可能）。
- 画像の著作権・ライセンス情報が提供元から取得できる場合は表示する。
- 外部APIキーはクライアントに直書きしない。

---

## 5. UI要件（ワイヤー概要）

### 5.1 おすすめ操作コンポーネント
- 位置: 画面下部ツールバーの上（fixed）。
- 状態1（アクション）: 「サムネイルを設定」ボタン + 補足テキスト。
- 状態2（候補）: 横スクロール候補一覧 + 「次へ」ボタン + 戻るボタン。

### 5.2 カード表示
- 画像は高さ固定、幅は内容に応じて可変。
- クリック領域はカード全体。
- 画像下に作者/提供元リンクを表示。

---

## 6. 検索ソース要件

### 6.1 目標
- Wikipedia以外の画像も含める。
- 無料または無料枠で利用可能なAPIを優先する。

### 6.2 候補例
- Wikimedia Commons（既存）
- Pexels / Pixabay / Unsplash（写真系）
- Bing Image Search（一般Web画像）
- Google Custom Search（一般Web画像）

### 6.3 取得方式（必須）
- **サーバー経由の検索プロキシ**を用意する。
  - 理由: CORS回避 / APIキー秘匿 / 利用規約遵守
- フロントは `GET /api/image-search?query=...&offset=...` のようなAPIを呼び出す。
- APIレスポンスは「画像URL + プレビューURL + 作者/提供元リンク」を返す。

### 6.4 マルチソース検索（Wikipedia以外）
- Wikimedia Commonsに加え、**他ソース**（例: Pexels / Pixabay / Bing / Openverse）からも取得する。
- ソースごとに**利用規約・無料枠**の確認が必須。
- APIレスポンスはソースに依存しない**正規化フォーマット**に変換する。

### 6.5 ページング（次へ）API仕様
- APIは次の10件を返すための**ページング情報**を含める。
- 例: `nextCursor` または `nextOffset` を返し、フロントは「次へ」でその値を送る。
- 検索結果が尽きた場合は `nextCursor` を返さない。

### 6.6 APIレスポンスの正規化形式（案）
```json
{
  "items": [
    {
      "id": "string",
      "previewUrl": "string",
      "imageUrl": "string",
      "alt": "string",
      "sourceName": "string",
      "sourceUrl": "string",
      "authorName": "string?",
      "authorUrl": "string?"
    }
  ],
  "nextCursor": "string?"
}
```

---

## 7. Gyazo保存フロー要件

### 7.1 保存の前提
- Gyazo APIは **バイナリの画像ファイル** を要求する。
- Webの画像URLをそのまま送信できないため、**取得 → バイナリ化 → Gyazoアップロード**が必要。

### 7.2 実装方針（推奨）
- フロントではなくサーバー側で画像取得とGyazo保存を行う。
  - `POST /api/thumbnail/commit`  
    - body: `{ sourceUrl, title }`
    - server: 画像取得 → Gyazoへアップロード → Gyazo URLを返す
- 成功時にフロントで「先頭に画像挿入 → 即保存」を行う。

### 7.3 バックエンド新規実装要件
- 既存バックエンドがないため、新規APIサーバーを実装する。
- フレームワークは任意（Hono / Express / Serverless等）。
- 必須エンドポイント:
  - `GET /api/image-search`  
    - query: `query`, `cursor|offset`, `limit=10`
  - `POST /api/thumbnail/commit`  
    - body: `{ sourceUrl, title }`

---

## 8. 受け入れ基準（AC）
- サムネイル未設定のページで「サムネイルを設定」が表示される。
- ボタンを押すとタイトル検索が行われ、10件表示される。
- 「次へ」で次の10件が表示される。
- 画像を選択するとGyazoに保存され、先頭に挿入される。
- 既存の先頭画像が2番目に移動する。
- 作者/提供元リンクが表示される。

---

## 9. 未確定事項（要検討）
- 具体的な検索API（Bing/Google/Pexels/Pixabay等）の選定
- APIコスト・無料枠・利用規約の整合性
- 右側プレビューUIやAIチャット連携との整合
